name: Deploy to Cloudflare Workers

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: Test Python Worker
        run: |
          echo "Testing Python worker compilation..."
          python -m py_compile src/cloudflare_worker.py
          echo "Python worker compiles successfully!"
          
          echo "Testing Python imports..."
          python -c "import requests, bs4, lxml; print('All required packages imported successfully')"
          
          echo "Testing wrangler configuration..."
          if [ -f "wrangler.toml" ]; then
            echo "‚úÖ wrangler.toml found"
            echo "üìÅ Main entry point: $(grep '^main =' wrangler.toml | cut -d'=' -f2 | tr -d ' ')"
            echo "üêç Python Workers enabled: $(grep 'python_workers' wrangler.toml | wc -l)"
          else
            echo "‚ùå wrangler.toml not found"
            exit 1
          fi
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.19.0'
          
      - name: Install Wrangler
        run: |
          echo "Node.js version:"
          node --version
          echo "npm version:"
          npm --version
          echo "Installing Wrangler..."
          npm install -g wrangler
        
      - name: Authenticate with Cloudflare
        run: |
          # Check if API token is available
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "‚úÖ API token found, using token-based authentication"
            
            # Create wrangler config directory structure
            echo "Creating Wrangler config directory..."
            mkdir -p ~/.wrangler/config
            
            # Verify directory was created
            if [ -d ~/.wrangler/config ]; then
              echo "‚úÖ Wrangler config directory created successfully"
            else
              echo "‚ùå Failed to create Wrangler config directory"
              exit 1
            fi
            
            # Create wrangler config file with API token
            echo "Creating Wrangler config file..."
            echo 'api_token = "${{ secrets.CLOUDFLARE_API_TOKEN }}"' > ~/.wrangler/config/default.toml
            
            # Verify the file was created
            if [ -f ~/.wrangler/config/default.toml ]; then
              echo "‚úÖ Wrangler config file created successfully"
              echo "Config file contents (token hidden):"
              cat ~/.wrangler/config/default.toml | sed 's/api_token = ".*"/api_token = "***HIDDEN***"/'
            else
              echo "‚ùå Failed to create Wrangler config file"
              exit 1
            fi
            
            # Test authentication
            echo "Testing authentication..."
            export CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
            if wrangler whoami > /dev/null 2>&1; then
              echo "‚úÖ Token-based authentication successful!"
            else
              echo "‚ö†Ô∏è  Token-based authentication failed, but continuing..."
            fi
          else
            echo "‚ö†Ô∏è  No API token found, will attempt deployment without explicit authentication"
            echo "Note: You may need to set CLOUDFLARE_API_TOKEN in your repository secrets"
            echo "Visit: https://dash.cloudflare.com/profile/api-tokens"
            
            # Create empty wrangler directory structure for verification
            echo "Creating empty Wrangler directory structure..."
            mkdir -p ~/.wrangler/config
            echo "‚úÖ Empty Wrangler directory structure created"
          fi
          
      - name: Verify Wrangler Setup
        run: |
          echo "Node.js environment:"
          echo "  Node: $(node --version)"
          echo "  npm: $(npm --version)"
          echo "  npx: $(npx --version)"
          
          echo "Wrangler version:"
          wrangler --version
          
          echo "Wrangler configuration:"
          if [ -d ~/.wrangler ]; then
            ls -la ~/.wrangler/
            if [ -d ~/.wrangler/config ]; then
              ls -la ~/.wrangler/config/
            else
              echo "‚ö†Ô∏è  ~/.wrangler/config directory does not exist"
            fi
          else
            echo "‚ö†Ô∏è  ~/.wrangler directory does not exist"
            echo "Creating it now..."
            mkdir -p ~/.wrangler/config
            echo "‚úÖ Created ~/.wrangler/config directory"
          fi
          
          echo "Current working directory:"
          pwd
          
          echo "Home directory:"
          echo "  HOME: $HOME"
          echo "  User: $(whoami)"
          
          echo "Project structure:"
          ls -la
          
          echo "Node.js path:"
          which node
          echo "npm path:"
          which npm
          
          echo "Wrangler configuration file:"
          cat wrangler.toml
          
          echo "Python environment:"
          echo "  Python: $(python3 --version)"
          echo "  pip: $(pip3 --version)"
          
          echo "Checking API token availability..."
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "‚úÖ API token is available (length: ${#CLOUDFLARE_API_TOKEN})"
          else
            echo "‚ö†Ô∏è  API token is not available"
            echo "Note: This will limit some functionality but deployment may still work"
            echo "To set up API token:"
            echo "1. Go to: https://dash.cloudflare.com/profile/api-tokens"
            echo "2. Create a new token with Workers permissions"
            echo "3. Add it to your repository secrets as CLOUDFLARE_API_TOKEN"
          fi
          
          echo "Checking if worker exists..."
          if wrangler whoami > /dev/null 2>&1; then
            echo "Successfully authenticated with Cloudflare"
          else
            echo "Authentication failed, but continuing with deployment..."
          fi
          
          echo "Checking Python worker file..."
          if [ -f "src/cloudflare_worker.py" ]; then
            echo "‚úÖ Python worker file found"
            echo "üìä File size: $(wc -c < src/cloudflare_worker.py) bytes"
          else
            echo "‚ùå Python worker file not found"
            exit 1
          fi
          
      - name: Deploy to Cloudflare Workers
        run: |
          # Set Cloudflare API token as environment variable if available
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            export CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
            CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
            echo "API token set: ${CLOUDFLARE_API_TOKEN:0:8}..."
          else
            echo "‚ö†Ô∏è  No API token available, proceeding without explicit authentication"
          fi
          
          # Determine environment
          if [ "${{ github.ref_name }}" = "main" ]; then
            ENV="production"
          else
            ENV="staging"
          fi
          
          echo "Deploying to environment: $ENV"
          echo "Using branch: ${{ github.ref_name }}"
          
          # Verify authentication before deployment
          echo "Verifying authentication..."
          if wrangler whoami > /dev/null 2>&1; then
            echo "‚úÖ Authentication verified, proceeding with deployment..."
          else
            echo "‚ö†Ô∏è  Authentication failed, but attempting deployment anyway..."
          fi
          
          # Check if worker exists and deploy
          echo "Attempting deployment..."
          if wrangler deploy --env $ENV; then
            echo "Deployment completed successfully!"
          else
            echo "Deployment failed, checking error..."
            echo "Attempting to create worker with --force flag..."
            # If deployment fails, try to create the worker first
            if wrangler deploy --env $ENV --force; then
              echo "Worker created and deployed successfully!"
            else
              echo "Failed to create worker, exiting with error"
              exit 1
            fi
          fi
          
      - name: Verify Deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 10
          
          echo "Checking worker status..."
          if wrangler whoami; then
            echo "Worker authentication successful!"
          else
            echo "Worker authentication failed, but deployment may still be successful"
          fi
          
          echo "Checking deployment status..."
          echo "Worker should be available at:"
          echo "  - Staging: https://alopecosa-crawler-staging.tchoff.workers.dev"
          echo "  - Production: https://alopecosa-crawler-prod.tchoff.workers.dev"
          
          echo "Deployment verification completed!"
          
      - name: Deploy to specific environment (manual trigger)
        if: github.event_name == 'workflow_dispatch'
        run: |
          # Set Cloudflare API token as environment variable if available
          if [ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            export CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
            CLOUDFLARE_API_TOKEN="${{ secrets.CLOUDFLARE_API_TOKEN }}"
            echo "API token set: ${CLOUDFLARE_API_TOKEN:0:8}..."
          else
            echo "‚ö†Ô∏è  No API token available, proceeding without explicit authentication"
          fi
          
          echo "Deploying to environment: ${{ github.event.inputs.environment }}"
          
          # Verify authentication before deployment
          echo "Verifying authentication..."
          if wrangler whoami > /dev/null 2>&1; then
            echo "‚úÖ Authentication verified, proceeding with deployment..."
          else
            echo "‚ö†Ô∏è  Authentication failed, but attempting deployment anyway..."
          fi
          
          # Check if worker exists and deploy
          echo "Attempting manual deployment..."
          if wrangler deploy --env ${{ github.event.inputs.environment }}; then
            echo "Manual deployment completed successfully!"
          else
            echo "Manual deployment failed, checking error..."
            echo "Attempting to create worker with --force flag..."
            # If deployment fails, try to create the worker first
            if wrangler deploy --env ${{ github.event.inputs.environment }} --force; then
              echo "Worker created and deployed successfully!"
            else
              echo "Failed to create worker, exiting with error"
              exit 1
            fi
          fi
          
      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment successful!"
            echo "üåê Your worker is now live!"
            echo "üìä Check Cloudflare dashboard for details"
            echo "üîó Worker URLs:"
            echo "   - Staging: https://alopecosa-crawler-staging.tchoff.workers.dev"
            echo "   - Production: https://alopecosa-crawler-prod.tchoff.workers.dev"
          else
            echo "‚ùå Deployment failed!"
            echo "üîç Check the logs above for error details"
            echo "üí° Common issues:"
            echo "   - Missing API token (most likely cause)"
            echo "   - Worker already exists"
            echo "   - Python compilation errors"
            echo "üõ†Ô∏è  Solutions:"
            echo "   1. Set up API token: https://dash.cloudflare.com/profile/api-tokens"
            echo "   2. Add to GitHub secrets: CLOUDFLARE_API_TOKEN"
            echo "   3. Test locally: wrangler deploy --env staging"
          fi
